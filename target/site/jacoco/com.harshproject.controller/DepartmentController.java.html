<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>DepartmentController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">DepartmentSpringboot</a> &gt; <a href="index.source.html" class="el_package">com.harshproject.controller</a> &gt; <span class="el_source">DepartmentController.java</span></div><h1>DepartmentController.java</h1><pre class="source lang-java linenums">package com.harshproject.controller;
import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.harshproject.dto.DepartmentDTO;
import com.harshproject.exception.DepartmentNotFoundException;
import com.harshproject.exception.MyJsonConversionException;
import com.harshproject.service.DepartmentService;
import com.harshproject.util.DepartmentEmailAspect;

import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.Parameter;
import io.swagger.v3.oas.annotations.enums.ParameterIn;
import io.swagger.v3.oas.annotations.responses.ApiResponses;
import io.swagger.v3.oas.annotations.security.SecurityRequirement;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpStatus;
import org.springframework.http.RequestEntity;
import org.springframework.http.ResponseEntity;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;
import io.swagger.v3.oas.annotations.headers.Header;
import io.swagger.v3.oas.annotations.responses.ApiResponse;

import java.util.List;
import java.util.Optional;

@RestController
@RequestMapping(&quot;/department&quot;)
@SecurityRequirement(name = &quot;bearer-key&quot;)
public class DepartmentController {
<span class="fc" id="L35">	private static final Logger logger = LoggerFactory.getLogger(DepartmentController.class);</span>

    private final DepartmentService departmentService;
    private final RabbitTemplate rabbitTemplate;
    private final DepartmentEmailAspect departmentEmailAspect;
    private static final String DEPARTMENT_NOT_FOUND_MESSAGE = &quot;Department not found with ID: &quot;;

    public DepartmentController(DepartmentService departmentService, RabbitTemplate rabbitTemplate,
<span class="fc" id="L43">                                DepartmentEmailAspect departmentEmailAspect) {</span>
<span class="fc" id="L44">        this.departmentService = departmentService;</span>
<span class="fc" id="L45">        this.rabbitTemplate = rabbitTemplate;</span>
<span class="fc" id="L46">        this.departmentEmailAspect = departmentEmailAspect;</span>
<span class="fc" id="L47">    }</span>

    @GetMapping
    @PreAuthorize(&quot;hasAuthority('ROLE_USER')&quot;)
    @Operation(summary = &quot;Get all departments&quot;, description = &quot;Retrieve a list of all departments&quot;)
    public ResponseEntity&lt;List&lt;DepartmentDTO&gt;&gt; getAllDepartments(RequestEntity&lt;Void&gt; requestEntity) {
<span class="fc" id="L53">        HttpHeaders headers = requestEntity.getHeaders();</span>
<span class="fc" id="L54">        logger.info(&quot;Fetching all Departments. Request Headers: {}&quot;, headers);</span>

<span class="fc" id="L56">        List&lt;DepartmentDTO&gt; departmentDTOs = departmentService.getAllDepartmentDTOs();</span>
<span class="fc" id="L57">        return new ResponseEntity&lt;&gt;(departmentDTOs, HttpStatus.OK);</span>
    }

    @GetMapping(&quot;/{id}&quot;)
    @PreAuthorize(&quot;hasAuthority('ROLE_USER')&quot;)
    @Operation(summary = &quot;Get department by ID&quot;, description = &quot;Retrieve a department by its ID&quot;)
    public ResponseEntity&lt;DepartmentDTO&gt; getDepartmentById(
            @Parameter(name = &quot;id&quot;, description = &quot;ID of the department&quot;, in = ParameterIn.PATH, required = true)
            @PathVariable long id, RequestEntity&lt;Void&gt; requestEntity) {
<span class="fc" id="L66">        HttpHeaders headers = requestEntity.getHeaders();</span>
<span class="fc" id="L67">        logger.info(&quot;Fetching department by ID: {}. Request Headers: {}&quot;, id, headers);</span>

        try {
<span class="fc" id="L70">            Optional&lt;DepartmentDTO&gt; departmentDTOOptional = departmentService.getDepartmentDTOById(id);</span>
<span class="fc" id="L71">            return departmentDTOOptional.map(departmentDTO -&gt; new ResponseEntity&lt;&gt;(departmentDTO, HttpStatus.OK))</span>
<span class="fc" id="L72">                    .orElseThrow(() -&gt; {</span>
<span class="nc" id="L73">                        departmentEmailAspect.sendErrorEmail(&quot;getDepartmentById&quot;,DEPARTMENT_NOT_FOUND_MESSAGE + id);</span>
<span class="nc" id="L74">                        return new DepartmentNotFoundException(DEPARTMENT_NOT_FOUND_MESSAGE + id);</span>
                    });
<span class="nc" id="L76">        } catch (DepartmentNotFoundException ex) {</span>
            // Use your DepartmentEmailAspect to send an email
<span class="nc" id="L78">            departmentEmailAspect.sendErrorEmail(&quot;getDepartmentById&quot;,DEPARTMENT_NOT_FOUND_MESSAGE + id);</span>

            // Re-throw the exception to be handled globally
<span class="nc" id="L81">            throw ex;</span>
        }
    }

    @PutMapping(&quot;/{id}&quot;)
    @PreAuthorize(&quot;hasAuthority('ROLE_USER')&quot;)
    @Operation(summary = &quot;Update department by ID&quot;, description = &quot;Update a department based on its ID&quot;)
    public ResponseEntity&lt;DepartmentDTO&gt; updateDepartment(
            @Parameter(name = &quot;id&quot;, description = &quot;ID of the department&quot;, in = ParameterIn.PATH, required = true)
            @PathVariable Long id,
            @Parameter(name = &quot;updatedDepartmentDTO&quot;, description = &quot;Updated department information&quot;, required = true)
            @RequestBody DepartmentDTO updatedDepartmentDTO, RequestEntity&lt;Void&gt; requestEntity) {
<span class="fc" id="L93">        HttpHeaders headers = requestEntity.getHeaders();</span>
<span class="fc" id="L94">        logger.info(&quot;Updating department with ID {}: {}. Request Headers: {}&quot;, id, updatedDepartmentDTO, headers);</span>

        try {
<span class="fc" id="L97">            Optional&lt;DepartmentDTO&gt; updated = departmentService.updateDepartmentDTO(id, updatedDepartmentDTO);</span>
<span class="fc" id="L98">            return updated.map(updatedDTO -&gt; new ResponseEntity&lt;&gt;(updatedDTO, HttpStatus.OK))</span>
<span class="fc" id="L99">                    .orElseThrow(() -&gt; {</span>
<span class="nc" id="L100">                        departmentEmailAspect.sendErrorEmail(&quot;updateDepartment&quot;, &quot;Department not found with ID: &quot; + id);</span>
<span class="nc" id="L101">                        return new DepartmentNotFoundException(DEPARTMENT_NOT_FOUND_MESSAGE+ id);</span>
                    });
<span class="nc" id="L103">        } catch (DepartmentNotFoundException ex) {</span>
            // Use your DepartmentEmailAspect to send an email
<span class="nc" id="L105">            departmentEmailAspect.sendErrorEmail(&quot;updateDepartment&quot;,DEPARTMENT_NOT_FOUND_MESSAGE + id);</span>

            // Re-throw the exception to be handled globally
<span class="nc" id="L108">            throw ex;</span>
        }
    }

    @DeleteMapping(&quot;/{id}&quot;)
    @PreAuthorize(&quot;hasAuthority('ROLE_USER')&quot;)
    @Operation(summary = &quot;Delete department by ID&quot;, description = &quot;Delete a department based on its ID&quot;)
    public ResponseEntity&lt;Void&gt; deleteDepartment(
            @Parameter(name = &quot;id&quot;, description = &quot;ID of the department&quot;, in = ParameterIn.PATH, required = true)
            @PathVariable Long id, RequestEntity&lt;Void&gt; requestEntity) {
<span class="fc" id="L118">        HttpHeaders headers = requestEntity.getHeaders();</span>
<span class="fc" id="L119">        logger.info(&quot;Deleting department with ID: {}. Request Headers: {}&quot;, id, headers);</span>

<span class="fc" id="L121">        departmentService.deleteDepartmentDTO(id);</span>
<span class="fc" id="L122">        return new ResponseEntity&lt;&gt;(HttpStatus.NO_CONTENT);</span>
    }

    @PostMapping
    @PreAuthorize(&quot;hasAuthority('ROLE_USER')&quot;)
    @Operation(summary = &quot;Save new department&quot;, description = &quot;Save a new department&quot;)
    public ResponseEntity&lt;DepartmentDTO&gt; saveDepartment(
            @Parameter(name = &quot;departmentDTO&quot;, description = &quot;New department information&quot;, required = true)
            @RequestBody DepartmentDTO departmentDTO, RequestEntity&lt;Void&gt; requestEntity) {
<span class="fc" id="L131">        HttpHeaders headers = requestEntity.getHeaders();</span>
<span class="fc" id="L132">        logger.info(&quot;Saving a new Department: {}. Request Headers: {}&quot;, departmentDTO, headers);</span>

<span class="fc" id="L134">        DepartmentDTO savedDepartmentDTO = departmentService.saveDepartmentDTO(departmentDTO);</span>

<span class="fc" id="L136">        return new ResponseEntity&lt;&gt;(savedDepartmentDTO, HttpStatus.CREATED);</span>
    }


    @PostMapping(&quot;/rabbitmq/save&quot;)
    @Operation(summary = &quot;Save new department with RabbitMQ&quot;, description = &quot;Save a new department and send a message to RabbitMQ&quot;)
    @ApiResponses(value = {
            @ApiResponse(responseCode = &quot;201&quot;, description = &quot;Department saved successfully&quot;,
                    headers = @Header(name = &quot;Message&quot;, description = &quot;Message sent successfully&quot;)),
            @ApiResponse(responseCode = &quot;400&quot;, description = &quot;Bad request&quot;),
            @ApiResponse(responseCode = &quot;500&quot;, description = &quot;Internal server error&quot;)
    })
    public ResponseEntity&lt;DepartmentDTO&gt; saveDepartmentWithRabbitMQ(
            @Parameter(name = &quot;departmentDTO&quot;, description = &quot;New department information&quot;, required = true)
            @RequestBody DepartmentDTO departmentDTO, RequestEntity&lt;Void&gt; requestEntity) {
<span class="nc" id="L151">        HttpHeaders headers = requestEntity.getHeaders();</span>
<span class="nc" id="L152">        logger.info(&quot;Saving a new Department: {}. Request Headers: {}&quot;, departmentDTO, headers);</span>

<span class="nc" id="L154">        departmentDTO.setId(null);</span>

<span class="nc" id="L156">		DepartmentDTO savedDepartmentDTO = departmentService.saveDepartmentDTO(departmentDTO);</span>

<span class="nc" id="L158">		String message = convertDepartmentDTOToJson(savedDepartmentDTO);</span>
<span class="nc" id="L159">		rabbitTemplate.convertAndSend(&quot;department-exchange&quot;, &quot;myRoutingKey&quot;, message);</span>

<span class="nc" id="L161">		HttpHeaders responseHeaders = new HttpHeaders();</span>
<span class="nc" id="L162">		responseHeaders.add(&quot;Message&quot;, &quot;Message sent successfully&quot;);</span>

<span class="nc" id="L164">		return ResponseEntity.status(HttpStatus.CREATED)</span>
<span class="nc" id="L165">		        .headers(responseHeaders)</span>
<span class="nc" id="L166">		        .body(savedDepartmentDTO);</span>
    }

    @PutMapping(&quot;/{id}/rabbitmq/update&quot;)
    @Operation(summary = &quot;Update department by ID with RabbitMQ&quot;, description = &quot;Update a department based on its ID and send a message to RabbitMQ&quot;)
    public ResponseEntity&lt;DepartmentDTO&gt; updateDepartmentWithRabbitMQ(
            @Parameter(name = &quot;id&quot;, description = &quot;ID of the department&quot;, in = ParameterIn.PATH, required = true)
            @PathVariable Long id,
            @Parameter(name = &quot;updatedDepartmentDTO&quot;, description = &quot;Updated department information&quot;, required = true)
            @RequestBody DepartmentDTO updatedDepartmentDTO, RequestEntity&lt;Void&gt; requestEntity) {
<span class="nc" id="L176">        HttpHeaders headers = requestEntity.getHeaders();</span>
<span class="nc" id="L177">        logger.info(&quot;Updating department with ID {}: {}. Request Headers: {}&quot;, id, updatedDepartmentDTO, headers);</span>

        try {
<span class="nc" id="L180">            updatedDepartmentDTO.setId(id);</span>

<span class="nc" id="L182">            Optional&lt;DepartmentDTO&gt; updated = departmentService.updateDepartmentDTO(id, updatedDepartmentDTO);</span>

<span class="nc" id="L184">            String message = convertDepartmentDTOToJson(updatedDepartmentDTO);</span>
<span class="nc" id="L185">            rabbitTemplate.convertAndSend(&quot;department-exchange&quot;, &quot;myRoutingKey&quot;, message);</span>

<span class="nc" id="L187">            HttpHeaders responseHeaders = new HttpHeaders();</span>
<span class="nc" id="L188">            responseHeaders.add(&quot;Message&quot;, &quot;Message sent successfully&quot;);</span>

<span class="nc" id="L190">            return updated.map(updatedDTO -&gt; ResponseEntity.ok()</span>
<span class="nc" id="L191">                    .headers(responseHeaders)</span>
<span class="nc" id="L192">                    .body(updatedDTO))</span>
<span class="nc" id="L193">                    .orElseGet(() -&gt; ResponseEntity.notFound()</span>
<span class="nc" id="L194">                            .headers(responseHeaders)</span>
<span class="nc" id="L195">                            .build());</span>
<span class="nc" id="L196">        } catch (Exception e) {</span>
<span class="nc" id="L197">            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();</span>
        }
    }
    
    public String convertDepartmentDTOToJson(DepartmentDTO departmentDTO) {
        try {
<span class="nc" id="L203">            ObjectMapper objectMapper = new ObjectMapper();</span>
<span class="nc" id="L204">            return objectMapper.writeValueAsString(departmentDTO);</span>
<span class="nc" id="L205">        } catch (JsonProcessingException e) {</span>
<span class="nc" id="L206">            throw new MyJsonConversionException(&quot;Error converting DepartmentDTO to JSON&quot;, e);</span>
        }
    }
}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>